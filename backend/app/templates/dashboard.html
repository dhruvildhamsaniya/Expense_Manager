{% extends "base.html" %}

{% block title %}Dashboard - Expense Manager{% endblock %}

{% block extra_css %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .stat-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin: 0.5rem 0;
    }
    
    .stat-label {
        opacity: 0.9;
        font-size: 0.9rem;
    }
    
    /* NEW: Budget progress bar styles */
    .budget-item {
        margin-bottom: 1.5rem;
        padding: 1rem;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
    }
    
    .budget-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .budget-name {
        font-weight: 600;
        font-size: 1.1rem;
    }
    
    .budget-amounts {
        font-size: 0.9rem;
        color: #666;
    }
    
    .progress-bar {
        width: 100%;
        height: 24px;
        background-color: #f0f0f0;
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }
    
    .progress-fill {
        height: 100%;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .progress-ok {
        background-color: #2ecc71;
    }
    
    .progress-warning {
        background-color: #f39c12;
    }
    
    .progress-danger {
        background-color: #e74c3c;
    }
    
    .alert-box {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        border-color: #f39c12;
        color: #856404;
    }
    
    .alert-danger {
        background-color: #f8d7da;
        border-color: #e74c3c;
        color: #721c24;
    }
    
    .recurring-item {
        padding: 0.75rem;
        border-left: 3px solid #3498db;
        background-color: #f8f9fa;
        margin-bottom: 0.5rem;
        border-radius: 4px;
    }

    #expenseChart {
        max-width: 350px;
        max-height: 350px;
        margin: 0 auto;
    }

    
    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }
        
        nav ul {
            flex-direction: column;
            gap: 0.5rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">Dashboard</h1>

<!-- NEW: Budget Alerts Section -->
<div id="budgetAlerts"></div>

<div class="card">
    <h3>Filter By Date Range</h3>
    <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
        <input type="date" id="startDate" class="form-control">
        <input type="date" id="endDate" class="form-control">
        <button onclick="loadDashboard()" class="btn btn-primary">Apply</button>
    </div>
</div>

<div class="dashboard-grid">
    <div class="stat-card">
        <div class="stat-label">Total Expenses</div>
        <div class="stat-value" id="totalExpenses">$0.00</div>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
        <div class="stat-label">Number of Transactions</div>
        <div class="stat-value" id="totalTransactions">0</div>
    </div>
    
    <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
        <div class="stat-label">Top Category</div>
        <div class="stat-value" id="topCategory" style="font-size: 1.5rem;">-</div>
    </div>
</div>

<!-- NEW: Budget vs Actual Section -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>Budget Overview</h3>
        <a href="/budgets" class="btn btn-primary">Manage Budgets</a>
    </div>
    <div id="budgetOverview">
        <p style="color: #666;">No budgets set for this month. <a href="/budgets">Create a budget</a></p>
    </div>
</div>

<div class="card">
    <h3>Monthly Breakdown by Category</h3>
    <canvas id="expenseChart"></canvas>
</div>

<div class="card">
    <h3>Category Breakdown</h3>
    <div id="categoryBreakdown"></div>
</div>

<!-- NEW: Upcoming Recurring Expenses -->
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3>Upcoming Recurring Expenses</h3>
        <a href="/recurring" class="btn btn-primary">Manage Recurring</a>
    </div>
    <div id="upcomingRecurring">
        <p style="color: #666;">No active recurring expenses.</p>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let chart;

// Set default dates (current month)
const today = new Date();
const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0);

document.getElementById('startDate').valueAsDate = firstDay;
document.getElementById('endDate').valueAsDate = lastDay;

async function loadDashboard() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate || !endDate) {
        showAlert('Please select both start and end dates', 'error');
        return;
    }
    
    try {
        // Load regular dashboard data
        const response = await fetch(`/api/dashboard/monthly?start_date=${startDate}&end_date=${endDate}`);
        const data = await response.json();
        
        if (response.ok) {
            updateDashboard(data);
        } else {
            showAlert(data.detail || 'Failed to load dashboard', 'error');
        }
        
        // NEW: Load budget data
        const today = new Date();
        const month = today.getMonth() + 1;
        const year = today.getFullYear();

        await loadBudgetData(month, year);
        
        // NEW: Load upcoming recurring expenses
        await loadUpcomingRecurring();
        
    } catch (error) {
        showAlert('An error occurred while loading dashboard', 'error');
    }
}

// NEW: Load budget vs actual data
async function loadBudgetData(month, year) {
    try {
        const response = await fetch(`/api/budgets/vs-actual?month=${month}&year=${year}`);
        const budgets = await response.json();
        
        if (response.ok && budgets.length > 0) {
            displayBudgets(budgets);
        } else {
            document.getElementById('budgetOverview').innerHTML = 
                '<p style="color: #666;">No budgets set for this month. <a href="/budgets">Create a budget</a></p>';
        }
    } catch (error) {
        console.error('Error loading budget data:', error);
    }
}

// NEW: Display budget progress bars
function displayBudgets(budgets) {
    let alertsHtml = '';
    let html = '';
    
    budgets.forEach(budget => {
        const percentage = parseFloat(budget.percentage);
        const budgetAmount = parseFloat(budget.budget_amount);
        const actualAmount = parseFloat(budget.actual_amount);
        const remaining = parseFloat(budget.remaining);
        
        // Determine color and alert
        let progressClass = 'progress-ok';
        let alertType = null;
        
        if (percentage >= 100) {
            progressClass = 'progress-danger';
            alertType = 'danger';
            alertsHtml += `
                <div class="alert-box alert-danger">
                    <strong>üö® Budget Exceeded!</strong> 
                    ${budget.category_name}: ${actualAmount.toFixed(2)} / ${budgetAmount.toFixed(2)} (${percentage.toFixed(1)}%)
                </div>
            `;
        } else if (percentage >= 80) {
            progressClass = 'progress-warning';
            alertType = 'warning';
            alertsHtml += `
                <div class="alert-box alert-warning">
                    <strong>‚ö†Ô∏è Budget Warning!</strong> 
                    ${budget.category_name}: ${actualAmount.toFixed(2)} / ${budgetAmount.toFixed(2)} (${percentage.toFixed(1)}%)
                </div>
            `;
        }
        
        const displayPercentage = Math.min(percentage, 100);
        
        html += `
            <div class="budget-item">
                <div class="budget-header">
                    <span class="budget-name">${budget.category_name}</span>
                    <span class="budget-amounts">${actualAmount.toFixed(2)} / ${budgetAmount.toFixed(2)}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill ${progressClass}" style="width: ${displayPercentage}%">
                        ${percentage.toFixed(1)}%
                    </div>
                </div>
                <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                    ${remaining >= 0 ? `Remaining: ${remaining.toFixed(2)}` : `Over by: ${Math.abs(remaining).toFixed(2)}`}
                </div>
            </div>
        `;
    });
    
    document.getElementById('budgetAlerts').innerHTML = alertsHtml;
    document.getElementById('budgetOverview').innerHTML = html;
}

// NEW: Load upcoming recurring expenses
async function loadUpcomingRecurring() {
    try {
        const response = await fetch('/api/recurring-expenses/upcoming');
        const recurring = await response.json();
        
        if (response.ok && recurring.length > 0) {
            let html = '';
            recurring.slice(0, 5).forEach(item => {
                html += `
                    <div class="recurring-item">
                        <strong>${item.description || 'Recurring Expense'}</strong> - 
                        ${parseFloat(item.amount).toFixed(2)} ${item.currency}
                        <br>
                        <small>${item.category_name || 'Uncategorized'} ‚Ä¢ ${item.frequency}</small>
                    </div>
                `;
            });
            document.getElementById('upcomingRecurring').innerHTML = html;
        }
    } catch (error) {
        console.error('Error loading recurring expenses:', error);
    }
}

function updateDashboard(data) {
    // Update stats
    document.getElementById('totalExpenses').textContent = `${data.grand_total.toFixed(2)}`;
    document.getElementById('totalTransactions').textContent = data.totals.reduce((sum, cat) => {
        return cat.total > 0 ? sum + 1 : sum;
    }, 0);
    
    if (data.totals.length > 0 && data.totals[0].total > 0) {
        document.getElementById('topCategory').textContent = data.totals[0].category_name;
    } else {
        document.getElementById('topCategory').textContent = '-';
    }
    
    // Update chart
    const labels = data.totals.map(t => t.category_name);
    const values = data.totals.map(t => parseFloat(t.total));
    const colors = generateColors(data.totals.length);
    
    if (chart) {
        chart.destroy();
    }
    
    const ctx = document.getElementById('expenseChart').getContext('2d');
    chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: values,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toFixed(2)} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // Update category breakdown table
    let html = '<table><thead><tr><th>Category</th><th>Amount</th><th>Percentage</th></tr></thead><tbody>';
    
    data.totals.forEach(cat => {
        const percentage = ((parseFloat(cat.total) / data.grand_total) * 100).toFixed(1);
        html += `
            <tr>
                <td>${cat.category_name}</td>
                <td>${parseFloat(cat.total).toFixed(2)}</td>
                <td>${percentage}%</td>
            </tr>
        `;
    });
    
    html += '</tbody></table>';
    document.getElementById('categoryBreakdown').innerHTML = html;
}

function generateColors(count) {
    const colors = [
        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
        '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
    ];
    return colors.slice(0, count);
}

// Load dashboard on page load
loadDashboard();
</script>
{% endblock %}